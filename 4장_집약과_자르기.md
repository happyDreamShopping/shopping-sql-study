# 4장 집약과 자르기

<br>

## 집약

<br>

### 1. 여러 개의 레코드를 한개의 레코드로 집약

<br>

비집약 테이블

![KakaoTalk_Photo_2019-10-15-10-14-55](https://user-images.githubusercontent.com/10356931/66794937-03117f80-ef3e-11e9-99fc-6d14eb73def2.jpeg)

<br>

한 사람과 관련된 정보가 여러 개의 레코드에 분산되어 있는 테이블은 한사람의 정보에 접근할 때 where id = 'Jim' 와  select 구문을 사용할 때 당연히 3개의 레코드가 선택됩니다.

<br>

~~~sql
select id, data_1, data_2
from NonAggTbl
where id = 'jim'
and data_type = 'A';
~~~

data_type 이 B, C 도 비슷하게 해야 합니다 ㅠ

==> 한 사람과 관련된 정보가 여러 레코드에 분산되어 있어서 한 사람의 정보를 참조하려면 여러 레코드에 접근해야 합니다

<br>

아래 그림과 같은 레이아웃의 테이블로 만들거나 뷰 테이블을 만들어 사용하는 것이 바람직하다

![KakaoTalk_Photo_2019-10-15-10-23-45](https://user-images.githubusercontent.com/10356931/66794933-0278e900-ef3e-11e9-998a-0c9ff34979ff.jpeg)


<br>


case, group by를 사용해보자

![KakaoTalk_Photo_2019-10-15-10-24-02](https://user-images.githubusercontent.com/10356931/66794932-0278e900-ef3e-11e9-9a6a-67126c43d0c3.jpeg)

group by로 집약했을 때 select 구에 입력할 수 있는 것은 다음과 같은 3가지 뿐입니다.

- 상수
- group by 구에서 사용한 집약 키
- 집약 함수

> 저번에 얘기나온거처럼 mysql은 이런 코드를 입력할 수 있게 기능을 확장했습니다. 하지만 표준에는 없는 내용입니다. 호환되지 않는 내용은 추천하지 않습니다. ==> 집합론의 원리를 위배


<br>


![KakaoTalk_Photo_2019-10-15-10-24-09](https://user-images.githubusercontent.com/10356931/66794931-0278e900-ef3e-11e9-936b-10d4b73108eb.jpeg)

<br>

이 집약 쿼리의 실행계획은 어떻게 될까요? 141page

group by 의 집약 조작에 모두 '해시'라는 알고리즘을 사용하고 있습니다.

<br>

https://m.blog.naver.com/PostView.nhn?blogId=tttnnn1234&logNo=220143780136&proxyReferer=https%3A%2F%2Fwww.google.co.kr%2F

>  oracle 10g 부터는 'SORT GROUP BY' 보다 성능이 개선된 'HASH GROUP BY' 오퍼레이션을 대개 사용한다.

<br>

단, 정렬과 해시 GROUP BY는 모두 메모리를 많이 사용하므로 충분한 워킹 메모리가 확보되지 않으면 스왑이 발생합니다.

<br>

### 2. 합쳐서 하나

제품의 대상 연령별 가격을 관리하는 테이블이 있습니다.

![KakaoTalk_Photo_2019-10-15-10-36-05](https://user-images.githubusercontent.com/10356931/66794930-01e05280-ef3e-11e9-9e21-a55c0914e048.jpeg)

0~100세까지 모든 연령이 가지고 놀 수 있는 제품을 구하라입니다

<br>

![KakaoTalk_Photo_2019-10-15-10-40-35](https://user-images.githubusercontent.com/10356931/66794929-01e05280-ef3e-11e9-9da8-326cd9e7afed.jpeg)


<br>


## 자르기

![KakaoTalk_Photo_2019-10-15-10-53-40](https://user-images.githubusercontent.com/10356931/66794928-01e05280-ef3e-11e9-9129-b532f3be3371.jpeg)

<br>

이름 첫글자를 사용해 특정한 알파벳으로 시작하는 이름을 가진 사람이 몇 명인지 집계

<br>

![KakaoTalk_Photo_2019-10-15-10-54-02](https://user-images.githubusercontent.com/10356931/66795070-6d2a2480-ef3e-11e9-95df-713269be8926.jpeg)

<br>

이렇게 GROUP BY 구로 잘라 만든 하나하나의 부분 집합을 수학적으로 파티션이라고 부릅니다.

자르기의 기준이 되는 키를 GROUP BY 구와 SELECT 구 모두에 입력하는 것이 포인트입니다.

<br>

2장에서 GROUP BY 구에서 집약 기능을 제외하고 자르는 기능만 남긴 것이 윈도우 함수의 PARTITION BY 구 라고 했습니다.

<br>

![KakaoTalk_Photo_2019-10-15-11-03-56](https://user-images.githubusercontent.com/10356931/66794926-0147bc00-ef3e-11e9-9e2d-0929f9a4f001.jpeg)

<br>

PARTITION BY 구를 사용해도 단순한 필드 이름 뿐 아니라 CASE 식, 계산식을 사용한 기준을 사용할 수 있다는 말입니다.

<br>

GROUP BY 구는 입력 집합을 집약하므로 전혀 다른 레벨의 출력을 반환하지만, 

PARTITION BY 구는 입력에 정보를 추가할 뿐이므로 원본 테이블 정보를 완전히 그대로 유지합니다.
